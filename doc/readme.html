<html>
	<head>
		<title>Astrometry-api-lite readme</title>
		<style>
			body {
				font-family: Arial, Helvetica, sans-serif;
				margin: 1em auto;
				width: 80%;
				box-sizing: border-box;
			}

			h1 {
				display: inline-block;
				vertical-align: middle;
			}

			.logo {
				vertical-align: middle;
				margin-right:2em;
			}

			hr {
				color: #ccc;
				height: 2px;
				border: 0;
				background: #ccc;
			}

			.content {
				padding: 1em 0;
			}

			.conf thead tr {
				background: #ccc;
			}

			.conf th {
				text-align: left;
				background: beige;
				padding: 0.25em;
			}

			.conf td {
				padding: 0.25em;
				border-bottom: 1px dashed #ccc;
				padding-right: 1em;
			}

			.sign {
				border-left: 4px solid #ccc;
				padding-left: 1em;
			}

		</style>
	</head>
	<body>
		<img class="logo" src="minilogo.png" /><h1>Astrometry-api-lite</h1>
		<hr />
		<div class="content">
			<h2>Table of contents</h2>
			<ul>
				<li><a href="#overview">Overview</a></li>
				<li><a href="#install">Installer</a></li>
				<li><a href="#conf">Configuration</a></li>
				<li><a href="#dash">Dashboard</a></li>
				<li><a href="#trouble">Troubleshooting and notes</a></li>
				<li><a href="#source">Source</a></li>
			</ul>
		</div>
		<hr />
		<div class="content">
			<h2 id="overview">Overview</h2>
			<p>
				Astrometry-api-lite is a NodeJS application bundle that runs an astrometry.net equivalent API on your machine.
				Since astrometry.net packages require Linux to run the base requirement for running this software is Linux in
				one form or another.
			</p>
			<p>
				A pure Linux installation (or a VM) is a good choice but all the required software also runs on <b>Windows 10 Subsystem
				for Linux</b> which means a "pure Linux" is not a necessity, and you can run this API directly from your
				desktop as you have probably already figured out.
			</p>
			<p>
				The software package consists of three runnables: the <b>API</b>, the <b>Worker Manager</b> and the <b>Workers</b>.
				The API is the HTTP interface that applications use, the Worker Manager is responsible for spawning workers when
				there are solver jobs to complete and the Worker runs the solver and saves the results.
			</p>
			<h3>Usage</h3>
			<p>
				Where ever you would normally enter <b><a href="http://nova.astrometry.net">http://nova.astrometry.net</a></b>, you can now enter the address of your locally running
				API (by default <b><a href="http://localhost:3000">http://localhost:3000</a></b>). The API behaves like Nova's API would.
			</p>
		</div>
		<hr />
		<div class="content">
			<h2 id="install">Installer</h2>
			<p>
				The <b>Windows Installer</b> is a tool that you can use with <b>Windows 10 Subsystem for Linux</b>
				and it sets up everything for you, guided by a familiar user interface. The installer itself is very lean
				and does not contain anything else than the wizard user interface and the install script itself - everything
				else gets downloaded from the internet. You'll end up with a single desktop shortcut that starts both the API 
				and the Worker Manager.
			</p>
			<p>
				The installer can be run multiple times if something fails during the installation of if you need
				to reconfigure the API. Astrometry.net indexes will be downloaded using resume mechanics, so if a download
				fails or times out, progress should not be lost. <b>Note that there is no uninstaller available.</b> The installer does not write
				anything to registry, it only creates the target directory and runs the installation scripts there.
				So in order to really uninstall it, just delete the files - however this will leave the prerequisites
				(astrometry.net and nodejs mainly) installed inside the Linux Subsystem, if you wish to remove those
				you'll need to remove the packages using the bash console with a few apt commands.
			</p>
			<p>
				If you chose to download astrometry.net indexes, they will be stored in your <b>&lt;installation directory&gt;/indexes</b>.
			</p>
		</div>
		<hr />
		<div class="content">
			<h2 id="conf">Configuration</h2>
			<p>A few configuration values can be set for each application.</p>
			<br/>
			<h3>dist/api/configuration.json</h3>
			
			<table class="conf">
				<thead>
					<tr>
						<th>Key</th><th>Value</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>database</td><td>the path to the SQLite database file where the queue and results are stored</td>
					</tr>
					<tr>
						<td>queueFileUploadDir</td><td>the path where uploaded files are stored</td>
					</tr>
					<tr>
						<td>apiPort</td><td>which port the API http server uses. Note: do not use port 80 (requires root permissions)</td>
					</tr>
					<tr>
						<td>enableSwagger</td><td>enables or disables the swagger UI, accessible at /swagger</td>
					</tr>
					<tr>
						<td>enableDashboard</td><td>enables or disables the dashboard at /dashboard</td>
					</tr>
					<tr>
						<td>enableJobCancellationApi</td><td>enables or disables the job cancellation api, /api/job-control/cancel/{id}. When disabled the control API just returns 403</td>
					</tr>
				</tbody>
			</table>
			
			<p></p>
			<br/>

			<h3>dist/manager/configuration.json</h3>

			<table class="conf">
				<thead>
					<tr>
						<th>Key</th><th>Value</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>database</td><td>the path to the SQLite database file where the queue and results are stored</td>
					</tr>
					<tr>
						<td>worker</td><td>the path to the worker application</td>
					</tr>
					<tr>
						<td>maxConcurrentWorkers</td><td>how many concurrent workers are allowed to be spawned</td>
					</tr>						
				</tbody>
			</table>

			<p></p>
			<br/>

			<h3>dist/worker/configuration.json</h3>

			<table class="conf">
				<thead>
					<tr>
						<th>Key</th><th>Value</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>database</td><td>the path to the SQLite database file where the queue and results are stored</td>
					</tr>
					<tr>
						<td>queueFileUploadDir</td><td>the path where uploaded files are stored</td>
					</tr>
					<tr>
						<td>tempDir</td><td>the path where (temporary) result files produced by the solver are stored</td>
					</tr>
					<tr>
						<td>computationTimeLimit</td><td>the time limit for the solver, jobs that last longer will be aborted</td>
					</tr>
					<tr>
						<td>skipJobsOlderThanSeconds</td><td>the worker will abandon jobs that are older than this value in seconds (useful if the API has piled up jobs but the manager has been down, you don't want to start solving old jobs)</td>
					</tr>
					<tr>
						<td>storeObjsImages</td><td>true or false, whether or not you want to store the resulting object images for each job. Stores them in the job database in base64 format.</td>
					</tr>
					<tr>
						<td>storeNgcImages</td><td>true or false, whether or not you want to store the resulting NGC (annotation) images for each job. Stores them in the job database in base64 format.</td>
					</tr>
					<tr>
						<td>imageScale</td><td>Image scaling to apply to the saved images (if you want to save space)</td>
					</tr>
				</tbody>
			</table>
		</div>
		<hr />
		<div class="content">
			<h2 id="dash">Dashboard</h2>
			<p>
				The Dashboard, available at <a href="http://localhost:3000/dashboard">http://localhost:3000/dashboard</a> by default
				is a simple dashboard that displays the latest jobs, their statuses and the status of your Worker Manager and how
				many Workers are currently running. The dashboard automatically refreshes the data every 5 seconds.
			</p>
			<img src="dashboard.png" />
			<p>
				If you have configured the Workers to store object/annotation images from the results, you can click on the thumbnails
				from each job to view them.
			</p>
			<p>
				Additionally, if you've configured the API with <b>enableJobCancellationApi: true</b> you are also able to cancel
				running jobs from the dashboard - useful since solver tasks can take a lot of time to finish, and you don't want
				to wait for a botched job.
			</p>
		</div>		
		<hr />
		<div class="content">
			<h2 id="trouble">Troubleshooting</h2>
			<p>
				<b>First of all, important note:</b> do not try to run multiple parallel instances of the API or the Worker Manager!
				This may lead to job database corruption and the maxConcurrentWorkers setting loses all meaning as each manager only tracks
				its own child processes.
			</p>
			<p>
				Secondly, if you terminate the bash window, but you have other bash windows still open, <b>the processes will not terminate</b>!
				This is important to note! Only when the last bash window is closed, all the Linux subsystem processes will die.
				<b>So if you have a bash window open when you close the Astrometry-api-lite window, the processes will continue to run.</b>
				If you then run the Astrometry-api-lite from the shortcut, you'll have two parallel instances running - and that is bad.
				The proper way of closing the window is with <b>CTRL+C</b>, which signals abort to the processes - with that, the processes
				will die regardless of still having other bash windows open.
			</p>
			<p>
				<b>Q:</b> I'm getting an SQLITE error claiming my database is corrupted, what to do?
				<br/>
				<b>A:</b> This may happen when multiple processes mess with the database without cleanly
				completing transactions. If the database doesn't seem to recover, stop the processes 
				(In Win10 close the bash window, open a new bash from start menu, and run <i>killall -9 node</i> just to be sure), 
				copy a clean database to replace it from <i>src/common/workdb-template.db</i> and start the
				programs again.
			</p>			
		</div>	
		<hr />
		<div class="content">
			<h2 id="source">Source</h2>
			<p>
				This software is open source, and can be downloaded in its entirety from Github: <a href="https://github.com/Jusas/astrometry-api-lite">https://github.com/Jusas/astrometry-api-lite</a>				
			</p>
			<p>
				In fact, the Windows installer downloads the whole source package and runs the TypeScript compiler to compile the runnables - 
				so you already have the source on your machine. The compiled runnables are located in the dist/ directory, while most of the
				sources are in the src/ directory.
			</p><p>&nbsp;</p>
			<p>Thank you for choosing an open source product! :-)</p>
			<p class="sign"><i>Jussi Saarivirta</i>
			<br/><i>jusasi@gmail.com</i></p>
		</div>	
	</body>
</html>